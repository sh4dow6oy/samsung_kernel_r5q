name: Build Samsung Kernel (SM-G770F)

on:
  workflow_dispatch:
    inputs:
      model:
        description: "Device model (e.g., g770f)"
        required: true
        default: g770f

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      # 🔹 Checkout kernel source
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: sh4dow6oy/samsung_kernel_r5q
          ref: master
          submodules: recursive
          fetch-depth: 0

      # 🔹 Install dependencies
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git bc bison flex libssl-dev libncurses5-dev \
            libelf-dev wget tar xz-utils ccache lld llvm unzip zip zstd \
            python3 python3-distutils python3-setuptools

      # 🔹 Cache Neutron Clang
      - name: Cache Neutron Clang
        id: cache-clang
        uses: actions/cache@v4
        with:
          path: toolchain/clang
          key: neutron-clang-10032024

      # 🔹 Setup Neutron Clang if not cached
      - name: Setup Neutron Clang
        if: steps.cache-clang.outputs.cache-hit != 'true'
        run: |
          TOOLCHAIN_PATH="$PWD/toolchain/clang"
          mkdir -p "$TOOLCHAIN_PATH"
          cd "$TOOLCHAIN_PATH"
          wget -q https://github.com/Neutron-Toolchains/clang-build-catalogue/releases/download/10032024/neutron-clang-10032024.tar.zst
          tar --use-compress-program=unzstd -xf neutron-clang-10032024.tar.zst --strip-components=1

      # 🔹 Export Clang environment
      - name: Export Clang environment
        run: |
          TOOLCHAIN_PATH="$PWD/toolchain/clang"
          echo "PATH=$TOOLCHAIN_PATH/bin:$PATH" >> $GITHUB_ENV
          echo "CC=clang" >> $GITHUB_ENV
          echo "LD=ld.lld" >> $GITHUB_ENV
          echo "LLVM=1" >> $GITHUB_ENV
          echo "LLVM_IAS=1" >> $GITHUB_ENV
          clang --version

      # 🔹 Cache GCC 12.2
      - name: Cache GCC 12.2 aarch64
        id: cache-gcc
        uses: actions/cache@v4
        with:
          path: toolchain/aarch64-gcc-12.2
          key: gcc-12.2.0-prebuilt

      # 🔹 Setup GCC 12.2 aarch64 if not cached
      - name: Setup GCC 12.2 aarch64
        if: steps.cache-gcc.outputs.cache-hit != 'true'
        run: |
          GCC_PATH="$PWD/toolchain/aarch64-gcc-12.2"
          mkdir -p "$GCC_PATH"
          wget -q https://www.kernel.org/pub/tools/crosstool/files/bin/x86_64/12.2.0/x86_64-gcc-12.2.0-nolibc-aarch64-linux.tar.gz
          tar -xzf x86_64-gcc-12.2.0-nolibc-aarch64-linux.tar.gz -C "$GCC_PATH" --strip-components=1
          echo "✅ GCC extracted to $GCC_PATH"

      # 🔹 Export GCC environment
      - name: Export GCC environment
        run: |
          GCC_PATH="$PWD/toolchain/aarch64-gcc-12.2"
          BIN_GCC=$(find "$GCC_PATH/bin" -maxdepth 1 -type f -name "*gcc" | head -n1)
          if [ -z "$BIN_GCC" ]; then
            echo "❌ Nu am găsit gcc în $GCC_PATH/bin"
            exit 1
          fi
          PREFIX=$(basename "$BIN_GCC" | sed 's/gcc$//')
          echo "Detected GCC prefix: $PREFIX"
          echo "PATH=$GCC_PATH/bin:$PATH" >> $GITHUB_ENV
          echo "CROSS_COMPILE=$GCC_PATH/bin/$PREFIX" >> $GITHUB_ENV
          $GCC_PATH/bin/${PREFIX}gcc --version

      # 🔹 Detect defconfig
      - name: Detect defconfig
        id: detect-config
        run: |
          MODEL=${{ github.event.inputs.model }}
          DEFCONFIG=$(ls arch/arm64/configs/*_${MODEL}_defconfig 2>/dev/null || ls arch/arm64/configs/*_defconfig | head -n1)
          if [ -z "$DEFCONFIG" ]; then
            echo "❌ No defconfig found for model $MODEL"
            exit 1
          fi
          echo "DEFCONFIG_NAME=$(basename $DEFCONFIG)" >> $GITHUB_OUTPUT

      # 🔹 Clean output
      - name: Clean output
        run: rm -rf out

      # 🔹 Configure kernel
      - name: Configure kernel
        run: |
          make O=out ARCH=arm64 ${{ steps.detect-config.outputs.DEFCONFIG_NAME }} CC=$CC CROSS_COMPILE=$CROSS_COMPILE

      # 🔹 Patch kernel config (enable BPF + disable stack protector)
      - name: Patch kernel config
        run: |
          CONFIG=out/.config
          set_config() {
            key="$1"
            val="$2"
            if grep -qE "^${key}=" "$CONFIG"; then
              sed -i "s/^${key}=.*/${key}=${val}/" "$CONFIG"
            elif grep -qE "^# ${key} is not set$" "$CONFIG"; then
              sed -i "s/^# ${key} is not set$/${key}=${val}/" "$CONFIG"
            else
              echo "${key}=${val}" >> "$CONFIG"
            fi
          }

          # Enable BPF
          set_config "CONFIG_BPF" "y"
          set_config "CONFIG_BPF_SYSCALL" "y"
          set_config "CONFIG_BPF_JIT" "y"
          set_config "CONFIG_CGROUP_BPF" "y"
          set_config "CONFIG_BPF_EVENTS" "y"
          set_config "CONFIG_NET_CLS_BPF" "y"
          set_config "CONFIG_NET_ACT_BPF" "y"
          set_config "CONFIG_LIBBPF" "y"
          set_config "CONFIG_BPF_PRELOAD" "y"
          set_config "CONFIG_BPF_LSM" "y"

          # Disable stack protector
          sed -i 's/CONFIG_CC_STACKPROTECTOR_STRONG=y/# CONFIG_CC_STACKPROTECTOR_STRONG is not set/' "$CONFIG" || true
          sed -i 's/CONFIG_CC_STACKPROTECTOR=y/# CONFIG_CC_STACKPROTECTOR is not set/' "$CONFIG" || true
          set_config "CONFIG_CC_STACKPROTECTOR_NONE" "y"

          make O=out ARCH=arm64 olddefconfig

      # 🔹 Build kernel
      - name: Build kernel
        run: |
          make O=out ARCH=arm64 \
            CC=clang \
            CROSS_COMPILE=$CROSS_COMPILE \
            LD=ld.lld \
            LLVM=1 LLVM_IAS=1 \
            KCFLAGS="-fno-stack-protector" \
            KBUILD_CFLAGS="-fno-stack-protector" \
            KBUILD_CFLAGS_MODULE="-fno-stack-protector" \
            -j$(nproc)

      # 🔹 Upload kernel image
      - name: Upload kernel image
        uses: actions/upload-artifact@v4
        with:
          name: kernel-image
          path: out/arch/arm64/boot/Image.gz-dtb
